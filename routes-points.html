<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="background-info/buttons.css">
    <title>Airway Routes Study</title>
    <style>
        #map {
            background-image: url(background-info/Blank\ CERAP.png); 
            background-repeat: no-repeat;
             background-size:auto;
             height: 175vh;
             background-attachment:scroll;
            cursor: crosshair;
        }

        .point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }

        #question {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px;
            background-color: white;
            border: 2px solid #555;
            border-radius: 5px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
        }

        .popup.correct {
            border-color: green;
        }

        .popup.incorrect {
            border-color: red;
        }

        .line {
    position: absolute;
    background-color: blue;
    opacity: 0.6;
    z-index: -1;
}

    </style>
</head>
<body>
    <div class="button">
        <a href="index.html"><button>Home Page</button></a>
        <button id="skipButton">Skip</button>
        <button id="submitButton">Submit</button>
    </div>

    <div id="question">
        <!-- Question will be displayed here -->
    </div>

    <div id="map">
        <!-- Points will be added here dynamically -->
    </div>
    
    <div id="correctPopup" class="popup correct">
        Correct! Click on the next point.
    </div>
    
    <div id="incorrectPopup" class="popup incorrect">
        Try again.
    </div>

    <div id="results" style="display: none;">
        <!-- Results will be displayed here -->
    </div>

    <script>
        const fixes = [
    { label: "A", x: 224, y: 634 },
    { label: "B", x: 439, y: 784 },
    { label: "C", x: 570, y: 877 },
    { label: "D", x: 887, y: 1217 },
    { label: "E", x: 960, y: 1299 },
    { label: "F", x: 1173, y: 1487 },
    // ... add more fixes here
];

const routes = [
    {
        question: "Click on the points for L452, starting from either boundary fix.",
        answer: ["A", "B", "C", "D", "E", "F"]
    },
    {
        question: "Click on the points for L337, starting from either boundary fix.",
        answer: ["C", "D", "E"]
    },
    // ... (add more routes here)
];

        let shuffledRoutes = shuffleArray(routes);
        let currentRouteIndex = 0;
        let currentPointIndex = 0;
        let isDrawing = false;
        let startPoint = null;
        let incorrectRoutes = [];

        const clickTolerance = 15; // Adjust this value to define the acceptable area for clicks

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayQuestion(question) {
            document.getElementById('question').innerText = question;
        }

        function displayPopup(popupId) {
            const popup = document.getElementById(popupId);
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 1500); // Hide after 1.5 seconds
        }

        document.getElementById('map').addEventListener('mousedown', (event) => {
    const rect = document.getElementById('map').getBoundingClientRect();
    isDrawing = true;
    startPoint = {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
    };
    clickedPoint = {  // Define clickedPoint based on the mouse click
        x: startPoint.x,
        y: startPoint.y
    };
});

document.getElementById('map').addEventListener('mousemove', (event) => {
    if (!isDrawing) return;

    const newLine = document.createElement('div');
    newLine.className = 'line';
    newLine.style.left = `${clickedPoint.x}px`;  // Use clickedPoint instead of startPoint
    newLine.style.top = `${clickedPoint.y}px`;   // Use clickedPoint instead of startPoint
    newLine.style.width = `${event.clientX - clickedPoint.x}px`;  // Use clickedPoint instead of startPoint
    newLine.style.height = `${event.clientY - clickedPoint.y}px`;  // Use clickedPoint instead of startPoint
    document.getElementById('map').appendChild(newLine);
});
        document.addEventListener('mouseup', () => {
          // Inside the mouseup event listener
if (!isDrawing) return;

const currentRoute = shuffledRoutes[currentRouteIndex];
const currentAnswerLabel = currentRoute.answer[currentPointIndex];
const clickedFix = fixes.find(fix => fix.label === currentAnswerLabel);

if (clickedFix) {
    const isAnswerCorrect =
        (Math.abs(clickedPoint.x - clickedFix.x) <= clickTolerance &&
        Math.abs(clickedPoint.y - clickedFix.y) <= clickTolerance) ||
        (Math.abs(clickedPoint.x - clickedFix.x) <= clickTolerance &&
        Math.abs(clickedPoint.y - clickedFix.y) <= clickTolerance);

    if (isAnswerCorrect) {
        if (currentPointIndex === currentRoute.answer.length - 1) {
            if (currentRouteIndex === shuffledRoutes.length - 1) {
                showResults();
            } else {
                currentPointIndex = 0;
                currentRouteIndex++;
                displayQuestion(shuffledRoutes[currentRouteIndex].question);
            }
            // Display a special message for the final point
            displayPopup('correctPopup', 'Correct! Next question.');
        } else if (
            (currentPointIndex === 0 && clickedPoint.x === clickedFix.x && clickedPoint.y === clickedFix.y) ||
            (currentPointIndex === currentRoute.answer.length - 1 &&
            clickedPoint.x === currentRoute.answer[0].x && clickedPoint.y === currentRoute.answer[0].y)
        ) {
            currentPointIndex = currentRoute.answer.length - 1;
            displayPopup('correctPopup');
        } else {
            currentPointIndex++;
            displayPopup('correctPopup');
        }
    } else {
            // Check if the clicked point is also close to the ending fix
    const isAnswerCorrectEnd =
        Math.abs(clickedPoint.x - currentRoute.answer[currentRoute.answer.length - 1].x) <= clickTolerance &&
        Math.abs(clickedPoint.y - currentRoute.answer[currentRoute.answer.length - 1].y) <= clickTolerance;

    if (isAnswerCorrectEnd) {
        if (currentPointIndex === currentRoute.answer.length - 1) {
            if (currentRouteIndex === shuffledRoutes.length - 1) {
                showResults();
            } else {
                currentPointIndex = 0;
                currentRouteIndex++;
                displayQuestion(shuffledRoutes[currentRouteIndex].question);
            }
            // Display a special message for the final point
            displayPopup('correctPopup', 'Correct! Next question.');
        } else {
            currentPointIndex = currentRoute.answer.length - 1;
            displayPopup('correctPopup');
        }
    } else {
        displayPopup('incorrectPopup');
    }
}

document.getElementById('map').innerHTML = '';
isDrawing = false;
} else {
    // Handle if the clicked fix label is not found
}

        });

        function showResults() {
            const resultsElement = document.getElementById('results');
            const numCorrect = shuffledRoutes.length - incorrectRoutes.length;

            resultsElement.innerHTML = `Grade: ${numCorrect} out of ${shuffledRoutes.length}<br>`;
            resultsElement.innerHTML += `Missed routes: ${incorrectRoutes.join(', ')}`;
            resultsElement.style.display = 'block';
        }

        const skipButton = document.getElementById('skipButton');
        const submitButton = document.getElementById('submitButton');

        skipButton.addEventListener('click', () => {
            incorrectRoutes.push(currentRouteIndex);
            currentPointIndex = 0;
            currentRouteIndex++;
            displayQuestion(shuffledRoutes[currentRouteIndex].question);
            skipButton.style.display = 'none';
            submitButton.style.display = 'block';
        });

        submitButton.addEventListener('click', () => {
            if (currentPointIndex === currentRoute.answer.length - 1) {
                if (currentRouteIndex === shuffledRoutes.length - 1) {
                    showResults();
                } else {
                    currentPointIndex = 0;
                    currentRouteIndex++;
                    displayQuestion(shuffledRoutes[currentRouteIndex].question);
                }
            } else {
                currentPointIndex++;
            }
            skipButton.style.display = 'none';
            submitButton.style.display = 'none';
        });

        // Initialize with the first question
        displayQuestion(shuffledRoutes[currentRouteIndex].question);
    </script>
</body>
</html>
